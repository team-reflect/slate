{"version":3,"file":"index.js","sources":["../src/history.ts","../src/history-editor.ts","../src/with-history.ts"],"sourcesContent":["import isPlainObject from 'is-plain-object'\nimport { Operation } from 'slate'\n\n/**\n * `History` objects hold all of the operations that are applied to a value, so\n * they can be undone or redone as necessary.\n */\n\nexport interface History {\n  redos: Operation[][]\n  undos: Operation[][]\n}\n\nexport const History = {\n  /**\n   * Check if a value is a `History` object.\n   */\n\n  isHistory(value: any): value is History {\n    return (\n      isPlainObject(value) &&\n      Array.isArray(value.redos) &&\n      Array.isArray(value.undos) &&\n      (value.redos.length === 0 || Operation.isOperationList(value.redos[0])) &&\n      (value.undos.length === 0 || Operation.isOperationList(value.undos[0]))\n    )\n  },\n}\n","import { Editor } from 'slate'\nimport { History } from './history'\n\n/**\n * Weakmaps for attaching state to the editor.\n */\n\nexport const HISTORY = new WeakMap<Editor, History>()\nexport const SAVING = new WeakMap<Editor, boolean | undefined>()\nexport const MERGING = new WeakMap<Editor, boolean | undefined>()\n\n/**\n * `HistoryEditor` contains helpers for history-enabled editors.\n */\n\nexport interface HistoryEditor extends Editor {\n  history: History\n  undo: () => void\n  redo: () => void\n}\n\nexport const HistoryEditor = {\n  /**\n   * Check if a value is a `HistoryEditor` object.\n   */\n\n  isHistoryEditor(value: any): value is HistoryEditor {\n    return Editor.isEditor(value) && History.isHistory(value.history)\n  },\n\n  /**\n   * Get the merge flag's current value.\n   */\n\n  isMerging(editor: HistoryEditor): boolean | undefined {\n    return MERGING.get(editor)\n  },\n\n  /**\n   * Get the saving flag's current value.\n   */\n\n  isSaving(editor: HistoryEditor): boolean | undefined {\n    return SAVING.get(editor)\n  },\n\n  /**\n   * Redo to the previous saved state.\n   */\n\n  redo(editor: HistoryEditor): void {\n    editor.redo()\n  },\n\n  /**\n   * Undo to the previous saved state.\n   */\n\n  undo(editor: HistoryEditor): void {\n    editor.undo()\n  },\n\n  /**\n   * Apply a series of changes inside a synchronous `fn`, without merging any of\n   * the new operations into previous save point in the history.\n   */\n\n  withoutMerging(editor: HistoryEditor, fn: () => void): void {\n    const prev = HistoryEditor.isMerging(editor)\n    MERGING.set(editor, false)\n    fn()\n    MERGING.set(editor, prev)\n  },\n\n  /**\n   * Apply a series of changes inside a synchronous `fn`, without saving any of\n   * their operations into the history.\n   */\n\n  withoutSaving(editor: HistoryEditor, fn: () => void): void {\n    const prev = HistoryEditor.isSaving(editor)\n    SAVING.set(editor, false)\n    fn()\n    SAVING.set(editor, prev)\n  },\n}\n","import { Editor, Operation, Path } from 'slate'\n\nimport { HistoryEditor } from './history-editor'\n\n/**\n * The `withHistory` plugin keeps track of the operation history of a Slate\n * editor as operations are applied to it, using undo and redo stacks.\n */\n\nexport const withHistory = <T extends Editor>(editor: T) => {\n  const e = editor as T & HistoryEditor\n  const { apply } = e\n  e.history = { undos: [], redos: [] }\n\n  e.redo = () => {\n    const { history } = e\n    const { redos } = history\n\n    if (redos.length > 0) {\n      const batch = redos[redos.length - 1]\n\n      HistoryEditor.withoutSaving(e, () => {\n        Editor.withoutNormalizing(e, () => {\n          for (const op of batch) {\n            e.apply(op)\n          }\n        })\n      })\n\n      history.redos.pop()\n      history.undos.push(batch)\n    }\n  }\n\n  e.undo = () => {\n    const { history } = e\n    const { undos } = history\n\n    if (undos.length > 0) {\n      const batch = undos[undos.length - 1]\n\n      HistoryEditor.withoutSaving(e, () => {\n        Editor.withoutNormalizing(e, () => {\n          const inverseOps = batch.map(Operation.inverse).reverse()\n\n          for (const op of inverseOps) {\n            // If the final operation is deselecting the editor, skip it. This is\n            if (\n              op === inverseOps[inverseOps.length - 1] &&\n              op.type === 'set_selection' &&\n              op.newProperties == null\n            ) {\n              continue\n            } else {\n              e.apply(op)\n            }\n          }\n        })\n      })\n\n      history.redos.push(batch)\n      history.undos.pop()\n    }\n  }\n\n  e.apply = (op: Operation) => {\n    const { operations, history } = e\n    const { undos } = history\n    const lastBatch = undos[undos.length - 1]\n    const lastOp = lastBatch && lastBatch[lastBatch.length - 1]\n    const overwrite = shouldOverwrite(op, lastOp)\n    let save = HistoryEditor.isSaving(e)\n    let merge = HistoryEditor.isMerging(e)\n\n    if (save == null) {\n      save = shouldSave(op, lastOp)\n    }\n\n    if (save) {\n      if (merge == null) {\n        if (lastBatch == null) {\n          merge = false\n        } else if (operations.length !== 0) {\n          merge = true\n        } else {\n          merge = shouldMerge(op, lastOp) || overwrite\n        }\n      }\n\n      if (lastBatch && merge) {\n        if (overwrite) {\n          lastBatch.pop()\n        }\n\n        lastBatch.push(op)\n      } else {\n        const batch = [op]\n        undos.push(batch)\n      }\n\n      while (undos.length > 100) {\n        undos.shift()\n      }\n\n      if (shouldClear(op)) {\n        history.redos = []\n      }\n    }\n\n    apply(op)\n  }\n\n  return e\n}\n\n/**\n * Check whether to merge an operation into the previous operation.\n */\n\nconst shouldMerge = (op: Operation, prev: Operation | undefined): boolean => {\n  if (op.type === 'set_selection') {\n    return true\n  }\n\n  if (\n    prev &&\n    op.type === 'insert_text' &&\n    prev.type === 'insert_text' &&\n    op.offset === prev.offset + prev.text.length &&\n    Path.equals(op.path, prev.path)\n  ) {\n    return true\n  }\n\n  if (\n    prev &&\n    op.type === 'remove_text' &&\n    prev.type === 'remove_text' &&\n    op.offset + op.text.length === prev.offset &&\n    Path.equals(op.path, prev.path)\n  ) {\n    return true\n  }\n\n  return false\n}\n\n/**\n * Check whether an operation needs to be saved to the history.\n */\n\nconst shouldSave = (op: Operation, prev: Operation | undefined): boolean => {\n  if (op.type === 'set_selection' && op.newProperties == null) {\n    return false\n  }\n\n  return true\n}\n\n/**\n * Check whether an operation should overwrite the previous one.\n */\n\nconst shouldOverwrite = (\n  op: Operation,\n  prev: Operation | undefined\n): boolean => {\n  if (prev && op.type === 'set_selection' && prev.type === 'set_selection') {\n    return true\n  }\n\n  return false\n}\n\n/**\n * Check whether an operation should clear the redos stack.\n */\n\nconst shouldClear = (op: Operation): boolean => {\n  if (op.type === 'set_selection') {\n    return false\n  }\n\n  return true\n}\n"],"names":["History","isHistory","value","isPlainObject","Array","isArray","redos","undos","length","Operation","isOperationList","HISTORY","WeakMap","SAVING","MERGING","HistoryEditor","isHistoryEditor","Editor","isEditor","history","isMerging","editor","get","isSaving","redo","undo","withoutMerging","fn","prev","set","withoutSaving","withHistory","e","apply","batch","withoutNormalizing","op","pop","push","inverseOps","map","inverse","reverse","type","newProperties","operations","lastBatch","lastOp","overwrite","shouldOverwrite","save","merge","shouldSave","shouldMerge","shift","shouldClear","offset","text","Path","equals","path"],"mappings":"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"}